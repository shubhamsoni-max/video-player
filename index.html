<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Audio/Video Example - Record Plugin for Video.js</title>

    <link href="//vjs.zencdn.net/7.10.1/video-js.min.css" rel="stylesheet" />
    <link
      href="//unpkg.com/videojs-record/dist/css/videojs.record.min.css"
      rel="stylesheet"
    />

    <script src="//vjs.zencdn.net/7.10.1/video.min.js"></script>
    <script src="//unpkg.com/recordrtc/RecordRTC.js"></script>
    <script src="//unpkg.com/webrtc-adapter/out/adapter.js"></script>

    <script src="//unpkg.com/videojs-record/dist/videojs.record.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat&display=swap"
      rel="stylesheet"
    />
    <script src="https://kit.fontawesome.com/46b96ded5d.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="video-device">
      <select class="custom-video-select">
        <option value="">Select camera</option>
      </select>
    </div>
    <div class="audio-device">
      <select class="custom-audio-select">
        <option value="">Select Audio</option>
      </select>
    </div>

    <video id="myVideo" playsinline class="video-js vjs-default-skin">
      <p class="vjs-no-js">
        To view this video please enable JavaScript, or consider upgrading to a
        web browser that
        <a href="https://videojs.com/html5-video-support/" target="_blank">
          supports HTML5 video.
        </a>
      </p>
    </video>
    <!-- <div class="video-js">
      <div class="vjs-control-bar">
        <button>click</button>
      </div>
    </div> -->

    <script>
      var options = {
        controls: true,
        bigPlayButton: false,
        width: 320,
        height: 240,
        plugins: {
          record: {
            audio: true,
            video: true,
            maxLength: 10,
            displayMilliseconds: false,
            debug: true,
          },
        },
      };

      var player = videojs("myVideo", options, function () {
        // print version information at startup
        let vjs = document.querySelector(".vjs-control-bar");

        let myVideo = document.getElementById("myVideo");

        var msg =
          "Using video.js " +
          videojs.VERSION +
          " with videojs-record " +
          videojs.getPluginVersion("record") +
          " and recordrtc " +
          RecordRTC.version;
        videojs.log(msg);
        vjs.insertAdjacentHTML(
          "beforeend",
          `<span class = "video-btn"><i class="fas fa-video"></i></span>`
        );
        vjs.insertAdjacentHTML(
          "beforeend",
          `<span class = "mice-btn"><i class="fas fa-microphone-alt"></i></span>`
        );

        // select classes

        let video_device = document.querySelector(".video-device");
        let audio_device = document.querySelector(".audio-device");
        let custom_video_select = document.querySelector(
          ".custom-video-select"
        );
        let custom_audio_select = document.querySelector(
          ".custom-audio-select"
        );
        let video_btn = document.querySelector(".video-btn");
        let mice_btn = document.querySelector(".mice-btn");
        let currentStream;
        let enumeratorPromise = navigator.mediaDevices.enumerateDevices();
        function stopMediaTracks(stream) {
          stream.getTracks().forEach((track) => {
            track.stop();
          });
        }

        // list of video devices

        video_btn.addEventListener("click", () => {
          if (
            !navigator.mediaDevices ||
            !navigator.mediaDevices.enumerateDevices
          ) {
            console.log("enumerateDevices() not supported.");
            return;
          }
          // navigator.mediaDevices
          //   .enumerateDevices()
          //   .then(gotDevices)
          //   .catch(errorCallback);

          function gotDevices(devices) {
            custom_video_select.innerHTML = "";
            devices.forEach(function (device) {
              if (device.kind === "videoinput") {
                let option = video_device.appendChild(
                  document.createElement("option")
                );
                custom_video_select.length + 1;
                option.text = device.label;
                custom_video_select.append(option);
              }
              console.log(
                device.kind + ": " + device.label + " id = " + device.deviceId
              );
              device.addEventListener("click", (event) => {
                if (typeof currentStream !== "undefined") {
                  stopMediaTracks(currentStream);
                }
                const videoConstraints = {};
                if (custom_video_select.value === "") {
                  videoConstraints.facingMode = "environment";
                } else {
                  videoConstraints.deviceId = {
                    custom_video_select: select.value,
                  };
                }
                const constraints = {
                  video: videoConstraints,
                  audio: false,
                };
                navigator.mediaDevices
                  .getUserMedia(constraints)
                  .then((stream) => {
                    currentStream = stream;
                    video.srcObject = stream;
                    return navigator.mediaDevices.enumerateDevices();
                  })
                  .then(gotDevices)
                  .catch((error) => {
                    console.error(error);
                  });
              });
            });
          }

          navigator.mediaDevices.enumerateDevices().then(gotDevices);
        });

        // list of audio devices
        mice_btn.addEventListener("click", () => {
          if (
            !navigator.mediaDevices ||
            !navigator.mediaDevices.enumerateDevices
          ) {
            console.log("enumerateDevices() not supported.");
            return;
          }
          // navigator.mediaDevices
          //   .enumerateDevices()
          //   .then(gotDevices)
          //   .catch((err) => {
          //     console.log(err);
          //   });

          function gotDevices(devices) {
            custom_audio_select.innerHTML = "";
            devices.forEach(function (device) {
              if (device.kind === "audioinput") {
                let option = audio_device.appendChild(
                  document.createElement("option")
                );
                custom_audio_select.length + 1;
                option.text = device.label;
                custom_audio_select.append(option);
              }
              device.addEventListener("click", (event) => {
                if (typeof currentStream !== "undefined") {
                  stopMediaTracks(currentStream);
                }
                const audioConstraints = {};
                if (custom_audio_select.value === "") {
                  audioConstraints.facingMode = "environment";
                } else {
                  audioConstraints.deviceId = {
                    exact: custom_audio_select.value,
                  };
                }
                const constraints = {
                  video: false,
                  audio: audioConstraints,
                };
                navigator.mediaDevices
                  .getUserMedia(constraints)
                  .then((stream) => {
                    currentStream = stream;
                    audio.srcObject = stream;
                    return navigator.mediaDevices.enumerateDevices();
                  })
                  .then(gotDevices)
                  .catch((error) => {
                    console.error(error);
                  });
              });
            });
          }

          navigator.mediaDevices.enumerateDevices().then(gotDevices);
        });
      });

      // error handling
      player.on("deviceError", function () {
        console.log("device error:", player.deviceErrorCode);
      });

      player.on("error", function (element, error) {
        console.error(error);
      });

      // user clicked the record button and started recording
      player.on("startRecord", function () {
        console.log("started recording!");
      });

      // user completed recording and stream is available
      player.on("finishRecord", function () {
        // the blob object contains the recorded data that
        // can be downloaded by the user, stored on server etc.
        console.log("finished recording: ", player.recordedData);
      });

      // var icon = document.querySelector(".vjs-control-bar");
      // icon.setAttribute("data-icon", "\f107");
    </script>
  </body>
</html>
